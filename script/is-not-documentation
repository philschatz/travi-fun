COFFEE=./node_modules/.bin/coffee
UGLIFY=./node_modules/.bin/uglifyjs

echo "TRAVIS_COMMIT=${TRAVIS_COMMIT}"
echo "TRAVIS_COMMIT_RANGE=${TRAVIS_COMMIT_RANGE}"

# If this is the first commit on a branch then TRAVIS_COMMIT_RANGE is empty
# so just use the current commit
if [ -z ${TRAVIS_COMMIT_RANGE} ]
then
  START_COMMIT=${TRAVIS_COMMIT}
else
  START_COMMIT=$(echo ${TRAVIS_COMMIT_RANGE} | sed 's/\([a-z0-9]*\).*/\1/')
fi

echo "START_COMMIT=${START_COMMIT}"

# git checkout master
git checkout $(git rev-parse ${START_COMMIT}^1)

cat $(find ./src -name "*.coffee") | ${COFFEE} --compile --stdio | ${UGLIFY} --beautify > .cache-previous.js

git checkout ${TRAVIS_COMMIT}

cat $(find ./src -name "*.coffee") | ${COFFEE} --compile --stdio | ${UGLIFY} --beautify > .cache-this.js

diff ./.cache-previous.js ./.cache-this.js
